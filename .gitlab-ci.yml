stages:
  - test
  - scan
  - build
  - post-build-scan
  - deploy

variables:
  DOCKER_REGISTRY: 560397894482.dkr.ecr.ap-southeast-3.amazonaws.com
  IMAGE_NAME: kmm-frame-mobile
  IMAGE_TAG_STAGING: ${CI_COMMIT_SHORT_SHA}
  IMAGE_TAG_PRODUCTION: $CI_COMMIT_TAG
  DOCKERFILE_PATH: ./Dockerfile
  INFISICAL_ENV_PATH: /kacamatamoo/frame/kmm-frame-mobile
  GOCACHE: $CI_PROJECT_DIR/.cache/go-build
  GOMODCACHE: $CI_PROJECT_DIR/.cache/go-mod

.ecr_login: &ecr_login
  - bash ci/aws-ecr-login.sh

.go_cache: &go_cache
  key:
    files:
      - go.sum
  paths:
    - .cache/go-build
    - .cache/go-mod
  policy: pull-push

.tools_setup_cmds: &tools_setup_cmds
  - apk add --no-cache aws-cli bash curl wget ca-certificates jq gnupg lsb-release openssh-client sed
  - curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.alpine.sh' | bash
  - apk update && apk add infisical
  - chmod +x ci/*.sh

################################################################################
# TEST
################################################################################

lint:
  stage: test
  image: node:20.19.6-alpine3.22
  script:
    - npm ci
    - npm run lint
  only:
    - merge_requests
    - staging
    - main

################################################################################
# BUILD â†’ produces Docker image (Docker Buildx)
################################################################################

build:
  stage: build
  before_script:
    - *tools_setup_cmds
    - *ecr_login
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      variables:
        IMAGE_TAG: ${IMAGE_TAG_STAGING}-pre
        BUILD_TAG: "${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
        INFISICAL_ENVIRONMENT: staging
    - if: '$CI_COMMIT_TAG'
      variables:
        IMAGE_TAG: ${IMAGE_TAG_PRODUCTION}
        BUILD_TAG: "${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
        INFISICAL_ENVIRONMENT: prod

  script:
    - bash ci/infisical.sh
    - bash ci/build-docker-image.sh
  artifacts:
    paths:
      - .env
    expire_in: 1 hour
################################################################################
# SECURITY SCAN (Trivy)
################################################################################

trivy-scan-fs:
  stage: scan
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  allow_failure: false
  before_script:
    - apk add --no-cache bash
    - chmod +x ci/*.sh
  script:
    - bash ci/trivy-scan-fs.sh
  artifacts:
    paths:
      - trivy/
      - .trivycache/
    expire_in: 1 week

trivy-scan-image:
  stage: post-build-scan
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  needs:
    - job: build
      artifacts: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      variables:
        IMAGE_TAG: ${IMAGE_TAG_STAGING}-pre
    - if: '$CI_COMMIT_TAG'
      variables:
        IMAGE_TAG: ${IMAGE_TAG_PRODUCTION}
  allow_failure: false
  before_script:
    - apk add --no-cache bash
    - chmod +x ci/*.sh
  script:
    - bash ci/trivy-scan-docker.sh
  retry: 2
  artifacts:
    paths:
      - trivy/
      - .trivycache/
    expire_in: 1 week

deploy:staging:
  stage: deploy
  image: alpine:3.22.2
  needs:
    - job: build
      artifacts: true
    - job: trivy-scan-fs
      artifacts: true
    - job: trivy-scan-image
      artifacts: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      variables:
        IMAGE_TAG: ${IMAGE_TAG_STAGING}-pre
        DOCKER_HOST_SECRET_KEY_base64: $SSH_PRIVATE_KEY_BASE64_STAGING
        DOCKER_HOST: $SSH_HOST_STAGING
        DOCKER_USER: $SSH_USER_STAGING
        DOCKER_COMPOSE_PATH_ENV: staging
        DOCKER_SSH_PORT: ${DOCKER_SSH_PORT:-22}
        INFISICAL_ENVIRONMENT: staging
  before_script:
    - *tools_setup_cmds
  script:
    - bash ci/infisical.sh
    - bash ci/deploy.sh
  artifacts:
    paths:
      - .env
    expire_in: 1 hour
  retry: 2
  environment:
    name: staging
    url: https://$STAGING_URL

################################################################################
# DEPLOY PRODUCTION
################################################################################

deploy:production:
  stage: deploy
  image: alpine:3.22.2
  needs:
    - job: build
      artifacts: true
    - job: trivy-scan-fs
      artifacts: true
    - job: trivy-scan-image
      artifacts: true
  rules:
    - if: '$CI_COMMIT_TAG'
      variables:
        IMAGE_TAG: $IMAGE_TAG_PRODUCTION
        DOCKER_HOST_SECRET_KEY_base64: $SSH_PRIVATE_KEY_BASE64_PRODUCTION
        DOCKER_HOST: $SSH_HOST_PRODUCTION
        DOCKER_USER: $SSH_USER_PRODUCTION
        DOCKER_COMPOSE_PATH_ENV: production
        DOCKER_SSH_PORT: ${DOCKER_SSH_PORT:-22}
        INFISICAL_ENVIRONMENT: prod
  before_script:
    - *tools_setup_cmds
  script:
    - bash ci/infisical.sh
    - bash ci/deploy.sh
  artifacts:
    paths:
      - .env
    expire_in: 1 hour
  retry: 2
  environment:
    name: production
    url: https://$PRODUCTION_URL